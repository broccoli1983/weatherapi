<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Standard Meta -->
    <meta name="description" content="Download real-time images of Earth from the Himawari-8 satellite">
    <meta name="keywords"
        content="himawari, himawari-8, satellite, earth, js, javascript, download, real-time, code, fast, free">

    <!-- Open Graph -->
    <meta property="og:title" content="Himawari.js">
    <meta property="og:description" content="Download real-time images of Earth from the Himawari-8 satellite">
    <meta property="og:type" content="video">
    <meta property="og:image" content="http://i.imgur.com/kJcfCoN.jpg">
    <!-- <meta property="og:video" content="http://jakiestfu.s3.amazonaws.com/earth-web.mp4">
            <meta property="og:video:type" content="video/mp4">
            <meta property="og:video:width" content="2200">
            <meta property="og:video:height" content="2200"> -->
    <meta property="og:url" content="http://jakiestfu.github.io/himawari.js/demo/">
    <meta property="og:site_name" content="Himawari.js">
    <!-- Stylesheet -->
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>weatherapp</title>
</head>

<body>

    <div class="himawari">
        <a href="https://github.com/jakiestfu/himawari.js" class="video-link">
            <video autoplay loop src="http://jakiestfu.s3.amazonaws.com/earth-web.mp4"
                poster="http://i.imgur.com/kJcfCoN.jpg"></video>
        </a>
    </div>
    <div class="tenki"></div>
    <h3 id="place"></h3>
    <div id="now">
        <div id="weather">
        </div>
    </div>
    <table id="forecast">
    </table>

    <script>
        //geolocation
        function success(pos) {
            ajaxRequest(pos.coords.latitude, pos.coords.longitude);
        }

        function fail(error) {
            alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:' + error.code);
        }

        navigator.geolocation.getCurrentPosition(success, fail);

        //UTCã‚’ãƒŸãƒªç§’ã«
        function utcToJSTime(utcTime) {
            return utcTime * 1000;
        }

        //ãƒ‡ãƒ¼ã‚¿å–å¾—
        function ajaxRequest(lat, long) {
            const url = 'https://api.openweathermap.org/data/2.5/forecast';
            //appIdã«ã¯OpenWeatherMapã§å–å¾—ã—ãŸkeyã‚’å…¥åŠ›
            //äº‹å‰ã®ãƒ¦ãƒ¼ã‚¶ç™»éŒ²ãŒå¿…è¦ï¼ˆç„¡æ–™ï¼‰
            const appId = '676cdb7b8748ded4aff85952d1189dbd';

            $.ajax({
                url: url,
                data: {
                    appid: appId,
                    lat: lat,
                    lon: long,
                    units: 'metric',
                    lang: 'ja'
                }
            })
                .done(function (data) {
                    // console.log(data);

                    //éƒ½å¸‚åã€å›½å
                    $('#place').text(data.city.name + ', ' + data.city.country);

                    //å¤©æ°—äºˆå ±ãƒ‡ãƒ¼ã‚¿
                    data.list.forEach(function (forecast, index) {
                        const dateTime = new Date(utcToJSTime(forecast.dt));
                        const month = dateTime.getMonth() + 1;
                        const date = dateTime.getDate();
                        const hours = dateTime.getHours();
                        const min = String(dateTime.getMinutes()).padStart(2, '0');
                        const temperature = Math.round(forecast.main.temp);//æ°—æ¸©ã®è¨ˆç®—
                        const hum = Math.round(forecast.main.humidity);//æ¹¿åº¦ã®è¨ˆç®—
                        // console.log(hum);
                        const description = forecast.weather[0].description;
                        //ä¸å¿«æŒ‡æ•°ã®è¨ˆç®—
                        //ä¸å¿«æŒ‡æ•°=0.81*æ°—æ¸©+0.01*æ¹¿åº¦ï¼Šï¼ˆ0.99*æ¹¿åº¦-14.3ï¼‰+46.3
                        const thi = Math.round((0.81 * temperature) + (0.01 * hum) * (0.99 * hum - 14.3) + 46.3);//ä¸å¿«æŒ‡æ•°ã€THIã¨ç•¥ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚‹
                        console.log(thi);
                        //ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
                        const icon = forecast.weather[0].icon;
                        // console.log(icon);
                        function puddingInt(thi) {
                            if (0 <= thi && thi <= 60) {
                                return 'ğŸº'
                            } else if (61 <= thi && thi <= 70) {
                                return 'ğŸºğŸº'
                            } else if (71 <= thi && thi <= 80) {
                                return 'ğŸºğŸºğŸº'
                            } else if (81 <= thi && thi <= 90) {
                                return 'ğŸºğŸºğŸºğŸº'
                            } else if (91 <= thi) {
                                return 'ğŸºğŸºğŸºğŸºğŸº'
                            } else {
                                return '';
                            }
                        }
                        // const puddingScore = puddingInt(thi);
                        // console.log(puddingInt(thi));
                        // console.log(pugddingScore);
                        //ç¾åœ¨ã®å¤©æ°—ã¨ãã‚Œä»¥å¤–ã§å‡ºåŠ›ã‚’å¤‰ãˆã‚‹
                        if (index === 0) {
                            const currentWeather = `
<div class="info">
    <p>
        <span class="description">ç¾åœ¨ã®å¤©æ°—:${description}</span>
        <span class="temp">${temperature}</span>â„ƒ
        <span class="temp">${puddingInt(thi)}</span>
    </p>
</div>`;
                            $('#weather').html(currentWeather);
                        } else {
                            const tableRow = `
<tr>
    <td class="info">
        ${month}/${date} ${hours}:${min}
    </td>
    <td><img src="https://openweathermap.org/img/w/${icon}.png"></td>
    <td><span class="description">${description}</span></td>
    <td><span class="temp">${temperature}â„ƒ</span></td>
    <td><span class="temp">${puddingInt(thi)}</span></td>
</tr>`;
                            $('#forecast').append(tableRow);
                        }
                    })
                })
                .fail(function () {
                    console.log('$ajax failed!');
                })
        }
    </script>
    </div>
</body>

</html>